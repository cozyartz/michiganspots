name = "michiganspot"
compatibility_date = "2024-10-14"
compatibility_flags = ["nodejs_compat"]

pages_build_output_dir = "dist"

[[d1_databases]]
binding = "DB"
database_name = "michiganspot-db"
database_id = "3e7a780d-0058-43af-9e17-96d7925843b3"

# R2 Bucket for Legal Documents (PDFs)
[[r2_buckets]]
binding = "R2"
bucket_name = "michigan-spots-legal-documents"

# Cloudflare AI Binding for vector embeddings and semantic search
[ai]
binding = "AI"

# Vectorize index for semantic search (768-dimension BGE embeddings)
[[vectorize]]
binding = "VECTORIZE"
index_name = "michiganspots-embeddings"

# NOTE: Cron triggers are configured via Cloudflare Dashboard for Pages Functions
#
# Configured Cron Jobs:
# 1. Business AI Processing: 0 */6 * * * (every 6 hours)
#    - Endpoint: /api/directory-enrichment-cron
#    - Purpose: Process businesses with Cloudflare AI (quality scores, descriptions, keywords)
#
# 2. Embedding Health Check: 0 2 * * * (daily at 2 AM UTC)
#    - Endpoint: /api/cron/embedding-health-check
#    - Purpose: Monitor embedding coverage and auto-regenerate missing embeddings
#    - Auto-regenerates up to 10 missing embeddings per run
#
# 3. Web Scraper: 0 3 * * * (daily at 3 AM UTC)
#    - Endpoint: /api/cron/web-scraper
#    - Purpose: Pure HTML web scraper - crawls Michigan business directories
#    - NO EXTERNAL APIS REQUIRED - 100% self-contained
#    - Imports: ~10-20 new businesses per day
#    - Configure targets in: functions/api/cron/scraper-targets.ts
#
# 4. Auto-Refund Check: 0 4 * * * (daily at 4 AM UTC)
#    - Purpose: Process subscription refunds
#
# To configure in Cloudflare Dashboard:
# Workers & Pages > michiganspot > Settings > Triggers > Cron Triggers
#
# Required Secrets (add via: npx wrangler secret put SECRET_NAME --env production):
# - SEED_API_SECRET: Secret for seed-business API authentication
# - STRIPE_SECRET_KEY: Stripe secret key
# - STRIPE_WEBHOOK_SECRET: Stripe webhook secret
# - EVALIDATE_API_KEY: Email validation API key
# - CRON_SECRET: Cron job security secret

[vars]
SITE_URL = "http://localhost:4321"
STRIPE_PUBLISHABLE_KEY = "pk_live_51SQcd8RBOZWADDgwfw120F4UUrSDpd38EgHiNPWvqxHqO8Znzdspi8Dn2NlCpwzk8nxquS6WtIhmfPPgsO4rIedi00qksEHPEe"

# Sentry Client-Side Error Tracking (Public - exposed in browser)
PUBLIC_SENTRY_CLIENT_DSN = "https://704cddde6de4294b5a84f73c1b5029c0@o4510339428777984.ingest.us.sentry.io/4510339484680192"

# Partnership Tier Price IDs - Updated November 6, 2025 (MichiganSpots Stripe Account)
# Spot Partner
STRIPE_PRICE_SPOT_MONTHLY = "price_1SQcyRRBOZWADDgwLZZr5RZZ"
STRIPE_PRICE_SPOT_QUARTERLY = "price_1SQcypRBOZWADDgwPxFKp9YG"
STRIPE_PRICE_SPOT_YEARLY = "price_1SQcypRBOZWADDgwev52m2Jk"

# Featured Partner
STRIPE_PRICE_FEATURED_QUARTERLY = "price_1SQczkRBOZWADDgwbiGbeJG5"
STRIPE_PRICE_FEATURED_YEARLY = "price_1SQczkRBOZWADDgwEIQEmtvJ"

# Premium Sponsor
STRIPE_PRICE_PREMIUM_QUARTERLY = "price_1SQd07RBOZWADDgw1w4GIxIB"
STRIPE_PRICE_PREMIUM_YEARLY = "price_1SQd08RBOZWADDgwmJzAeHQ4"

# Title Sponsor
STRIPE_PRICE_TITLE_QUARTERLY = "price_1SQd0XRBOZWADDgwzxJgD4yg"
STRIPE_PRICE_TITLE_YEARLY = "price_1SQd0XRBOZWADDgwVWUZHrm4"

# Chamber Partnership
STRIPE_PRICE_CHAMBER_QUARTERLY = "price_1SQd0sRBOZWADDgwCKQ0aIUf"
STRIPE_PRICE_CHAMBER_YEARLY = "price_1SQd0tRBOZWADDgwKd1RoR6Q"

# Directory Advertising Tiers - Business Directory (Not game-related)
# Created: November 2025
# Note: FREE tier has no Stripe price (it's free)
STRIPE_PRICE_DIRECTORY_STARTER_MONTHLY = "price_1SR0QERBOZWADDgwvWIoqgLE"
STRIPE_PRICE_DIRECTORY_GROWTH_MONTHLY = "price_1SR0SURBOZWADDgwrwOFHuQ8"
STRIPE_PRICE_DIRECTORY_PRO_MONTHLY = "price_1SR0SXRBOZWADDgwCJpEDnQl"

# NOTE: Add these as secrets via Cloudflare Dashboard or wrangler:
# npx wrangler secret put STRIPE_SECRET_KEY --env production
# npx wrangler secret put STRIPE_WEBHOOK_SECRET --env production
# npx wrangler secret put EVALIDATE_API_KEY --env production
# npx wrangler secret put CRON_SECRET --env production
# npx wrangler secret put SEED_API_SECRET --env production
# npx wrangler secret put SENTRY_DSN --env production
#
# For Cloudflare Pages deployment, add these secrets in the Cloudflare Dashboard:
# 1. Go to Workers & Pages > michiganspot > Settings > Environment Variables
# 2. Add production secrets:
#    - STRIPE_SECRET_KEY (from Stripe Dashboard)
#    - STRIPE_WEBHOOK_SECRET (from Stripe Dashboard)
#    - EVALIDATE_API_KEY (from https://evalidate.andrea-b56.workers.dev)
#    - CRON_SECRET (any random string for cron job security)
#    - SEED_API_SECRET (any random string for business auto-seeding API security)
#    - SENTRY_DSN (from Sentry.io - Project Settings > Client Keys (DSN))
#      Format: https://xxxxx@xxxxx.ingest.sentry.io/xxxxx
#    - SENTRY_ENVIRONMENT (optional, defaults to "production")
#
# 3. Set up Cron Trigger for business AI processing:
#    - Go to Workers & Pages > michiganspot > Settings > Triggers > Cron Triggers
#    - Add trigger: "0 */6 * * *" (runs every 6 hours)
#    - This will automatically call /api/directory-enrichment-cron
#    - The cron job processes businesses with Cloudflare AI (quality scores, descriptions, keywords)
#
# 4. Business Auto-Seeding API:
#    - Endpoint: POST /api/directory/seed-business
#    - Requires header: x-seed-api-secret with SEED_API_SECRET value
#    - Supports single and bulk business imports with intelligent duplicate detection
#    - See BUSINESS_SEEDING_GUIDE.md for full documentation

[env.production]
[env.production.vars]
SITE_URL = "https://michiganspots.com"
STRIPE_PUBLISHABLE_KEY = "pk_live_51SQcd8RBOZWADDgwfw120F4UUrSDpd38EgHiNPWvqxHqO8Znzdspi8Dn2NlCpwzk8nxquS6WtIhmfPPgsO4rIedi00qksEHPEe"

# Sentry Client-Side Error Tracking (Public - exposed in browser)
PUBLIC_SENTRY_CLIENT_DSN = "https://704cddde6de4294b5a84f73c1b5029c0@o4510339428777984.ingest.us.sentry.io/4510339484680192"

# Production Stripe Price IDs (Live Mode) - Updated November 6, 2025 (MichiganSpots Stripe Account)
# Spot Partner
STRIPE_PRICE_SPOT_MONTHLY = "price_1SQcyRRBOZWADDgwLZZr5RZZ"
STRIPE_PRICE_SPOT_QUARTERLY = "price_1SQcypRBOZWADDgwPxFKp9YG"
STRIPE_PRICE_SPOT_YEARLY = "price_1SQcypRBOZWADDgwev52m2Jk"

# Featured Partner
STRIPE_PRICE_FEATURED_QUARTERLY = "price_1SQczkRBOZWADDgwbiGbeJG5"
STRIPE_PRICE_FEATURED_YEARLY = "price_1SQczkRBOZWADDgwEIQEmtvJ"

# Premium Sponsor
STRIPE_PRICE_PREMIUM_QUARTERLY = "price_1SQd07RBOZWADDgw1w4GIxIB"
STRIPE_PRICE_PREMIUM_YEARLY = "price_1SQd08RBOZWADDgwmJzAeHQ4"

# Title Sponsor
STRIPE_PRICE_TITLE_QUARTERLY = "price_1SQd0XRBOZWADDgwzxJgD4yg"
STRIPE_PRICE_TITLE_YEARLY = "price_1SQd0XRBOZWADDgwVWUZHrm4"

# Chamber Partnership
STRIPE_PRICE_CHAMBER_QUARTERLY = "price_1SQd0sRBOZWADDgwCKQ0aIUf"
STRIPE_PRICE_CHAMBER_YEARLY = "price_1SQd0tRBOZWADDgwKd1RoR6Q"

# Directory Advertising Tiers - Business Directory (Not game-related)
STRIPE_PRICE_DIRECTORY_STARTER_MONTHLY = "price_1SR0QERBOZWADDgwvWIoqgLE"
STRIPE_PRICE_DIRECTORY_GROWTH_MONTHLY = "price_1SR0SURBOZWADDgwrwOFHuQ8"
STRIPE_PRICE_DIRECTORY_PRO_MONTHLY = "price_1SR0SXRBOZWADDgwCJpEDnQl"

[[env.production.d1_databases]]
binding = "DB"
database_name = "michiganspot-db"
database_id = "3e7a780d-0058-43af-9e17-96d7925843b3"

[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "michigan-spots-legal-documents"

[env.production.ai]
binding = "AI"

[[env.production.vectorize]]
binding = "VECTORIZE"
index_name = "michiganspots-embeddings"
