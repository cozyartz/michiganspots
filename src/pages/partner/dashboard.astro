---
import Layout from '../../layouts/Layout.astro';
import { PartnerDashboard } from '../../components/PartnerDashboard';
---

<Layout
  title="Partner Dashboard | Michigan Spots"
  description="View your partnership performance and analytics"
  keywords="partner dashboard, analytics, michigan spots"
>
  <div id="auth-check" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
    <p>Verifying authentication...</p>
  </div>
  <div id="partner-content" style="display: none;">
    <PartnerDashboard client:load />
  </div>

  <script>
    // Client-side authentication check
    async function checkAuth() {
      try {
        // Check if there's a magic link token in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
          // Verify magic link token
          const verifyResponse = await fetch('/api/partner-auth/verify-magic-link', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
          });

          const verifyData = await verifyResponse.json();

          if (!verifyData.success) {
            window.location.href = `/?error=${encodeURIComponent(verifyData.error || 'Invalid magic link')}`;
            return;
          }

          // Remove token from URL and reload
          window.history.replaceState({}, document.title, '/partner/dashboard');
        }

        // Check if user is authenticated
        const response = await fetch('/api/auth/user');
        const data = await response.json();

        if (!data.user || (data.user.role !== 'partner' && data.user.role !== 'super_admin')) {
          window.location.href = '/?error=unauthorized';
          return;
        }

        // User is authenticated as partner or super admin
        document.getElementById('auth-check')!.style.display = 'none';
        document.getElementById('partner-content')!.style.display = 'block';
      } catch (error) {
        window.location.href = '/login?redirect=/partner/dashboard';
      }
    }

    checkAuth();
  </script>
</Layout>
