---
import Layout from '../layouts/Layout.astro';

// Fetch random featured businesses for the 404 page
const runtime = Astro.locals.runtime as {
  env: {
    DB: D1Database;
  };
};

let featuredBusinesses = [];
if (runtime?.env?.DB) {
  try {
    const result = await runtime.env.DB
      .prepare(
        `SELECT id, business_name, business_category, city, short_description
         FROM business_directory
         WHERE ai_processing_status = 'completed'
         ORDER BY RANDOM()
         LIMIT 4`
      )
      .all();
    featuredBusinesses = result.results || [];
  } catch (error) {
    console.error('Error fetching featured businesses:', error);
  }
}
---

<Layout
  title="404 - This Spot Doesn't Exist Yet | Michigan Spots"
  description="We couldn't find that page, but we can help you discover amazing Michigan businesses instead."
>
  <div class="min-h-screen relative bg-gradient-to-b from-parchment-light to-white" id="errorPage">
    <div class="container mx-auto px-4 py-12 max-w-6xl">

      <!-- Great Lakes Compass -->
      <div class="compass-container">
        <svg class="compass" viewBox="0 0 200 200" width="200" height="200">
          <!-- Outer circle -->
          <circle cx="100" cy="100" r="95" fill="none" stroke="#00274C" stroke-width="2" opacity="0.2"/>

          <!-- Cardinal directions with Great Lakes -->
          <g class="compass-labels">
            <text x="100" y="25" text-anchor="middle" class="compass-text" fill="#00274C">Superior</text>
            <text x="175" y="105" text-anchor="middle" class="compass-text" fill="#00274C">Huron</text>
            <text x="100" y="185" text-anchor="middle" class="compass-text" fill="#00274C">Erie</text>
            <text x="25" y="105" text-anchor="middle" class="compass-text" fill="#00274C">Michigan</text>
          </g>

          <!-- Rotating compass needle -->
          <g class="compass-needle" transform-origin="100 100">
            <polygon points="100,40 105,100 100,110 95,100" fill="#CC6600" stroke="#00274C" stroke-width="1"/>
            <polygon points="100,110 105,100 100,160 95,100" fill="#00274C" stroke="#00274C" stroke-width="1"/>
            <circle cx="100" cy="100" r="8" fill="#FFCB05" stroke="#00274C" stroke-width="2"/>
          </g>

          <!-- Tick marks -->
          <g class="tick-marks" opacity="0.3">
            {Array.from({length: 12}).map((_, i) => {
              const angle = (i * 30) - 90;
              const rad = (angle * Math.PI) / 180;
              const x1 = 100 + 85 * Math.cos(rad);
              const y1 = 100 + 85 * Math.sin(rad);
              const x2 = 100 + 95 * Math.cos(rad);
              const y2 = 100 + 95 * Math.sin(rad);
              return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#00274C" stroke-width="2"/>`;
            }).join('')}
          </g>
        </svg>
      </div>

      <!-- Main Error Message -->
      <div class="text-center mb-8">
        <h1 class="error-code">404</h1>
        <h2 class="error-title">This Michigan Spot Doesn't Exist Yet</h2>
        <p class="error-description">
          Looks like you've drifted off course. Let's help you discover the right spot.
        </p>
      </div>

      <!-- Search Bar -->
      <div class="search-section">
        <form action="/directory" method="get" class="search-form">
          <div class="search-input-wrapper">
            <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input
              type="text"
              name="search"
              placeholder="Search for Michigan businesses, restaurants, coffee shops..."
              class="search-input"
              autocomplete="off"
            />
          </div>
          <button type="submit" class="search-button">
            Search Spots
          </button>
        </form>

        <!-- Quick Category Filters -->
        <div class="category-chips">
          <a href="/directory?category=Restaurants" class="category-chip">Restaurants</a>
          <a href="/directory?category=Coffee Shops" class="category-chip">Coffee Shops</a>
          <a href="/directory?category=Shopping" class="category-chip">Shopping</a>
          <a href="/directory?category=Services" class="category-chip">Services</a>
        </div>
      </div>

      <!-- Featured Businesses -->
      {featuredBusinesses.length > 0 && (
        <div class="featured-section">
          <h3 class="featured-title">While You're Here, Discover These Spots:</h3>
          <div class="featured-grid">
            {featuredBusinesses.map((business: any) => (
              <a href={`/directory/${business.id}`} class="business-card">
                <div class="business-category">{business.business_category}</div>
                <h4 class="business-name">{business.business_name}</h4>
                <div class="business-location">{business.city}, MI</div>
                {business.short_description && (
                  <p class="business-description">{business.short_description}</p>
                )}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Navigation Options -->
      <div class="nav-section">
        <a href="/" class="nav-link nav-link-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          Return Home
        </a>
        <a href="/directory" class="nav-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          Browse All Spots
        </a>
        <a href="/blog" class="nav-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
          </svg>
          Read Our Blog
        </a>
      </div>

    </div>
  </div>
</Layout>

<script>
  // Animate compass needle rotation
  const needle = document.querySelector('.compass-needle');
  if (needle) {
    let rotation = 0;

    function rotateNeedle() {
      rotation += 0.5;
      needle.setAttribute('transform', `rotate(${rotation} 100 100)`);
      requestAnimationFrame(rotateNeedle);
    }

    rotateNeedle();
  }

  // Focus search input on load (desktop only)
  if (window.innerWidth > 768) {
    const searchInput = document.querySelector('.search-input') as HTMLInputElement;
    if (searchInput) {
      setTimeout(() => searchInput.focus(), 100);
    }
  }
</script>

<style>
  /* Compass Container */
  .compass-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 40px auto 60px;
  }

  .compass {
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
  }

  .compass-text {
    font-family: 'Georgia', serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  /* Error Code & Title */
  .error-code {
    font-family: 'Georgia', serif;
    font-size: clamp(80px, 15vw, 140px);
    font-weight: bold;
    color: #2D5016;
    line-height: 1;
    margin-bottom: 20px;
  }

  .error-title {
    font-family: 'Georgia', serif;
    font-size: clamp(28px, 5vw, 42px);
    font-weight: 600;
    color: #2D5016;
    margin-bottom: 16px;
  }

  .error-description {
    font-size: clamp(16px, 2.5vw, 20px);
    color: #5A5A5A;
    max-width: 600px;
    margin: 0 auto;
  }

  /* Search Section */
  .search-section {
    max-width: 700px;
    margin: 60px auto;
  }

  .search-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
  }

  .search-input-wrapper {
    position: relative;
    width: 100%;
  }

  .search-icon {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: #5A5A5A;
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: 18px 20px 18px 56px;
    font-size: 16px;
    border: 2px solid #2D5016;
    border-radius: 12px;
    background: white;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: #0066A1;
    box-shadow: 0 0 0 3px rgba(0, 102, 161, 0.1);
  }

  .search-input::placeholder {
    color: #999;
  }

  .search-button {
    padding: 18px 32px;
    background: #2D5016;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .search-button:hover {
    background: #1F3810;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
  }

  /* Category Chips */
  .category-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }

  .category-chip {
    padding: 10px 20px;
    background: white;
    border: 2px solid #2D5016;
    border-radius: 24px;
    color: #2D5016;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .category-chip:hover {
    background: #2D5016;
    color: white;
    transform: translateY(-2px);
  }

  /* Featured Section */
  .featured-section {
    max-width: 1200px;
    margin: 80px auto 60px;
  }

  .featured-title {
    font-family: 'Georgia', serif;
    font-size: clamp(24px, 4vw, 32px);
    font-weight: 600;
    color: #2D5016;
    text-align: center;
    margin-bottom: 40px;
  }

  .featured-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
  }

  .business-card {
    background: white;
    border: 2px solid #E8DCC8;
    border-radius: 16px;
    padding: 24px;
    text-decoration: none;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .business-card:hover {
    border-color: #0066A1;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }

  .business-category {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #CC6600;
  }

  .business-name {
    font-family: 'Georgia', serif;
    font-size: 20px;
    font-weight: 600;
    color: #2D5016;
    margin: 0;
  }

  .business-location {
    font-size: 14px;
    color: #5A5A5A;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .business-description {
    font-size: 14px;
    color: #666;
    line-height: 1.6;
    margin: 8px 0 0;
  }

  /* Navigation Section */
  .nav-section {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
    max-width: 800px;
    margin: 60px auto 40px;
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 28px;
    background: white;
    border: 2px solid #2D5016;
    border-radius: 12px;
    color: #2D5016;
    text-decoration: none;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .nav-link:hover {
    background: #2D5016;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 80, 22, 0.2);
  }

  .nav-link:hover svg {
    stroke: white;
  }

  .nav-link-primary {
    background: #2D5016;
    color: white;
  }

  .nav-link-primary:hover {
    background: #1F3810;
  }

  .nav-link-primary svg {
    stroke: white;
  }

  .nav-link svg {
    stroke: #2D5016;
    transition: stroke 0.3s ease;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .compass-container {
      margin: 30px auto 40px;
    }

    .compass {
      width: 160px;
      height: 160px;
    }

    .search-form {
      flex-direction: column;
    }

    .search-button {
      width: 100%;
    }

    .category-chips {
      justify-content: flex-start;
    }

    .featured-grid {
      grid-template-columns: 1fr;
    }

    .nav-section {
      flex-direction: column;
      width: 100%;
    }

    .nav-link {
      width: 100%;
      justify-content: center;
    }
  }

  @media (min-width: 769px) {
    .search-form {
      flex-direction: row;
      align-items: stretch;
    }

    .search-input-wrapper {
      flex: 1;
    }

    .search-button {
      width: auto;
      white-space: nowrap;
    }
  }
</style>
</Layout>
