---
import Layout from '../../layouts/Layout.astro';
import { DatabaseViewer } from '../../components/DatabaseViewer';

// This page requires server-side rendering for auth check
export const prerender = false;

// Check authentication
const sessionCookie = Astro.cookies.get('session');
if (!sessionCookie) {
  return Astro.redirect('/login?redirect=/admin/database');
}

// Verify session and role
const runtime = Astro.locals.runtime as any;
const db = runtime?.env?.DB;

if (!db) {
  return Astro.redirect('/login?error=db_unavailable');
}

const session = await db
  .prepare(`
    SELECT u.* FROM sessions s
    JOIN users u ON s.user_id = u.id
    WHERE s.id = ? AND s.expires_at > unixepoch()
  `)
  .bind(sessionCookie.value)
  .first();

if (!session || session.role !== 'super_admin') {
  return Astro.redirect('/?error=unauthorized');
}
---

<Layout
  title="Database Viewer | Michigan Spots Admin"
  description="View and manage D1 database tables"
  keywords="database, admin, D1, viewer"
>
  <DatabaseViewer client:load />
</Layout>
