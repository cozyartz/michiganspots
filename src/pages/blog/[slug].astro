---
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import Layout from '../../layouts/Layout.astro';
import { PostHero } from '../../components/PostHero';
import { TableOfContents } from '../../components/TableOfContents';
import { ShareButtons } from '../../components/ShareButtons';
import { RelatedPosts } from '../../components/RelatedPosts';
import { NewsletterSubscribe } from '../../components/NewsletterSubscribe';
import { BackToTop } from '../../components/BackToTop';
import { DarkModeToggle } from '../../components/DarkModeToggle';
import { Tag } from 'lucide-react';
import MDXComponents from '../../components/MDXComponents';

// Generate static paths for all blog posts
export const getStaticPaths = (async () => {
  const blogPosts = await getCollection('blog', ({ data }) => {
    return data.status === 'published';
  });

  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}) satisfies GetStaticPaths;

const { slug } = Astro.params;
const { post } = Astro.props;

// If no post prop, try to fetch it (for SSR fallback)
const blogPost = post || await getEntry('blog', slug as string);

if (!blogPost) {
  return Astro.redirect('/blog');
}

const { Content, headings } = await blogPost.render();
const { data } = blogPost;

// Calculate reading time (rough estimate: 200 words per minute)
const wordCount = blogPost.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// Get related posts (same category, excluding current post)
const allPosts = await getCollection('blog', ({ data }) => {
  return data.status === 'published';
});

const relatedPosts = allPosts
  .filter((p) => p.slug !== blogPost.slug && p.data.category === data.category)
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 3)
  .map((p) => ({
    slug: p.slug,
    title: p.data.title,
    excerpt: p.data.excerpt,
    category: p.data.category,
    featuredImage: p.data.featuredImage,
    publishedAt: p.data.publishedAt,
    readingTime: Math.ceil(p.body.split(/\s+/).length / 200),
  }));

// If not enough related posts from same category, add more from other categories
if (relatedPosts.length < 3) {
  const additionalPosts = allPosts
    .filter((p) => p.slug !== blogPost.slug && !relatedPosts.find((rp) => rp.slug === p.slug))
    .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
    .slice(0, 3 - relatedPosts.length)
    .map((p) => ({
      slug: p.slug,
      title: p.data.title,
      excerpt: p.data.excerpt,
      category: p.data.category,
      featuredImage: p.data.featuredImage,
      publishedAt: p.data.publishedAt,
      readingTime: Math.ceil(p.body.split(/\s+/).length / 200),
    }));
  relatedPosts.push(...additionalPosts);
}

// Format headings for TableOfContents
const tocHeadings = headings
  .filter((h) => h.depth <= 3)
  .map((h) => ({
    id: h.slug,
    text: h.text,
    level: h.depth,
  }));

// Generate structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": data.title,
  "description": data.excerpt,
  "image": data.featuredImage || "https://michiganspots.com/mispots_opt.png",
  "datePublished": new Date(data.publishedAt).toISOString(),
  "dateModified": data.updatedAt ? new Date(data.updatedAt).toISOString() : new Date(data.publishedAt).toISOString(),
  "author": {
    "@type": "Person",
    "name": data.authorName,
    "email": data.authorEmail
  },
  "publisher": {
    "@type": "Organization",
    "name": "Michigan Spots",
    "logo": {
      "@type": "ImageObject",
      "url": "https://michiganspots.com/mispots_opt.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://michiganspots.com/blog/${blogPost.slug}`
  },
  "keywords": data.keywords?.join(', ') || data.tags.join(', '),
  "articleSection": data.category,
  "inLanguage": "en-US"
};

// Breadcrumb structured data
const breadcrumbData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://michiganspots.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://michiganspots.com/blog"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": data.title,
      "item": `https://michiganspots.com/blog/${blogPost.slug}`
    }
  ]
};
---

<Layout
  title={data.seoTitle || data.title}
  description={data.seoDescription || data.excerpt}
  keywords={(data.keywords || data.tags).join(', ')}
>
  <!-- Initialize dark mode before page loads -->
  <script is:inline>
    // Run before page renders to prevent flash
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const shouldBeDark = savedTheme === 'dark' || (!savedTheme && prefersDark);

      if (shouldBeDark) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    })();
  </script>

  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />

  <div class="min-h-screen bg-parchment dark:bg-gradient-to-b dark:from-ink-primary dark:via-ink-faded/50 dark:to-ink-primary transition-colors duration-300">
    <!-- Floating Dark Mode Toggle -->
    <div class="fixed top-24 right-8 z-50">
      <DarkModeToggle client:load />
    </div>

    <!-- Hero Section -->
    <PostHero
      title={data.title}
      excerpt={data.excerpt}
      category={data.category}
      authorName={data.authorName}
      publishedAt={data.publishedAt}
      featuredImage={data.featuredImage}
      featuredImageAlt={data.featuredImageAlt}
      readingTime={readingTime}
      client:load
    />

    <!-- Main Content Area -->
    <div class="relative">
      <!-- Table of Contents Sidebar (Desktop) -->
      {tocHeadings.length > 0 && (
        <TableOfContents headings={tocHeadings} client:load />
      )}

      <!-- Article Content -->
      <article class="container mx-auto px-4 py-12 max-w-4xl">
        <!-- Breadcrumb Navigation -->
        <nav class="flex items-center gap-2 text-sm text-ink-secondary dark:text-parchment-light/70 mb-8">
          <a href="/" class="hover:text-copper-orange dark:hover:text-gold-treasure transition-colors">Home</a>
          <span>/</span>
          <a href="/blog" class="hover:text-copper-orange dark:hover:text-gold-treasure transition-colors">Blog</a>
          <span>/</span>
          <span class="text-ink-primary dark:text-parchment-light font-medium">{data.category}</span>
        </nav>

        <!-- Article Body with Enhanced Prose Styling -->
        <div class="prose prose-lg max-w-none">
          <Content components={MDXComponents} />
        </div>

        <!-- Affiliate Disclosure -->
        {data.hasAffiliateLinks && data.affiliateDisclosure && (
          <div class="mt-12 p-6 bg-gradient-to-br from-amber-primary/10 to-gold-treasure/10 dark:from-amber-primary/20 dark:to-gold-treasure/20 border-l-4 border-amber-primary dark:border-gold-treasure rounded-xl shadow-lg">
            <p class="text-sm text-ink-primary dark:text-parchment-light/90 leading-relaxed">
              <strong class="text-amber-dark dark:text-gold-treasure">ðŸ’° Affiliate Disclosure:</strong> This post contains affiliate links. If you make a purchase through these links, we may earn a small commission at no extra cost to you. This helps us keep Michigan Spots free and continue sharing amazing Michigan adventures!
            </p>
          </div>
        )}

        <!-- Tags Section -->
        {data.tags && data.tags.length > 0 && (
          <div class="mt-12 p-6 bg-parchment-mid dark:bg-ink-secondary border-2 border-parchment-dark dark:border-ink-faded rounded-2xl">
            <div class="flex items-center gap-3 mb-4">
              <Tag class="w-5 h-5 text-copper-orange dark:text-gold-treasure" />
              <h3 class="font-heading font-bold text-lg text-ink-primary dark:text-parchment-light">
                Topics Covered
              </h3>
            </div>
            <div class="flex items-center flex-wrap gap-3">
              {data.tags.map((tag: string) => (
                <a
                  href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                  class="px-4 py-2 bg-parchment-light dark:bg-ink-primary border-2 border-parchment-dark dark:border-ink-faded text-ink-secondary dark:text-parchment-light text-sm font-medium rounded-full hover:bg-copper-orange hover:text-parchment-light hover:border-copper-orange dark:hover:bg-gold-treasure dark:hover:text-ink-primary dark:hover:border-gold-treasure transition-all duration-300 transform hover:scale-105"
                >
                  {tag}
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Share Buttons -->
        <ShareButtons
          title={data.title}
          url={`https://michiganspots.com/blog/${blogPost.slug}`}
          description={data.excerpt}
          client:load
        />

        <!-- Related Posts -->
        {relatedPosts.length > 0 && (
          <RelatedPosts posts={relatedPosts} client:load />
        )}

        <!-- Newsletter Subscription -->
        <div class="mt-16">
          <NewsletterSubscribe client:load />
        </div>
      </article>
    </div>

    <!-- Back to Top Button -->
    <BackToTop client:load />
  </div>
</Layout>

<style>
  /* === ULTRA-MODERN BLOG POST TYPOGRAPHY === */

  .prose {
    color: var(--color-ink-primary);
    font-size: 18px;
    line-height: 1.7;
    max-width: 65ch;
    margin-left: auto;
    margin-right: auto;
  }

  /* Dark mode text color */
  :global(.dark) .prose {
    color: rgba(250, 251, 252, 0.95);
  }

  /* Lead paragraph - Engaging hook */
  .prose .lead {
    font-size: 22px;
    line-height: 1.6;
    font-weight: 400;
    margin-bottom: 3rem;
    color: var(--color-ink-secondary);
  }

  :global(.dark) .prose .lead {
    color: rgba(250, 251, 252, 0.85);
  }

  /* Main section headers (H2) - Bold statements */
  .prose h2 {
    font-family: var(--font-display);
    font-size: 32px;
    font-weight: 800;
    color: var(--color-ink-primary);
    margin-top: 4rem;
    margin-bottom: 1.5rem;
    line-height: 1.2;
    letter-spacing: -0.03em;
    position: relative;
    padding-bottom: 0.75rem;
  }

  :global(.dark) .prose h2 {
    color: rgba(250, 251, 252, 1);
  }

  /* Decorative underline for H2 */
  .prose h2::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(to right, var(--color-copper-orange), var(--color-gold-treasure));
    border-radius: 2px;
  }

  /* First h2 spacing */
  .prose .lead + h2,
  .prose h2:first-of-type {
    margin-top: 2.5rem;
  }

  /* Subsection headers (H3) */
  .prose h3 {
    font-family: var(--font-heading);
    font-size: 24px;
    font-weight: 700;
    color: var(--color-ink-primary);
    margin-top: 3rem;
    margin-bottom: 1.25rem;
    line-height: 1.3;
    letter-spacing: -0.02em;
  }

  :global(.dark) .prose h3 {
    color: rgba(250, 251, 252, 0.95);
  }

  /* Minor headers (H4) */
  .prose h4 {
    font-family: var(--font-heading);
    font-size: 20px;
    font-weight: 600;
    color: var(--color-ink-primary);
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    line-height: 1.4;
  }

  :global(.dark) .prose h4 {
    color: rgba(250, 251, 252, 0.95);
  }

  /* Paragraphs - Generous spacing */
  .prose p {
    margin-bottom: 2rem;
    line-height: 1.7;
    color: var(--color-ink-primary);
  }

  :global(.dark) .prose p {
    color: rgba(250, 251, 252, 0.9);
  }

  /* Strong emphasis */
  .prose strong {
    color: var(--color-ink-primary);
    font-weight: 700;
  }

  :global(.dark) .prose strong {
    color: rgba(250, 251, 252, 1);
  }

  /* Links - Vibrant and underlined */
  .prose a {
    color: var(--color-lakes-blue);
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 3px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .prose a:hover {
    color: var(--color-copper-orange);
    text-decoration-thickness: 3px;
  }

  :global(.dark) .prose a {
    color: var(--color-cyan-primary);
  }

  :global(.dark) .prose a:hover {
    color: var(--color-gold-treasure);
  }

  /* Lists - Clear hierarchy */
  .prose ul,
  .prose ol {
    margin-top: 1.75rem;
    margin-bottom: 2.25rem;
    padding-left: 1.75rem;
  }

  .prose li {
    margin-bottom: 1rem;
    line-height: 1.7;
    color: var(--color-ink-primary);
  }

  :global(.dark) .prose li {
    color: rgba(250, 251, 252, 0.9);
  }

  .prose li::marker {
    color: var(--color-copper-orange);
    font-weight: 700;
  }

  :global(.dark) .prose li::marker {
    color: var(--color-gold-treasure);
  }

  /* Nested lists */
  .prose ul ul,
  .prose ol ol,
  .prose ul ol,
  .prose ol ul {
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  /* Images - Full bleed on mobile, contained on desktop */
  .prose img {
    border-radius: 12px;
    margin: 3.5rem 0;
    box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .prose img:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.3);
  }

  :global(.dark) .prose img {
    box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.6);
  }

  /* Blockquotes - Distinctive styling */
  .prose blockquote {
    border-left: 4px solid var(--color-copper-orange);
    padding-left: 2rem;
    padding-top: 1rem;
    padding-bottom: 1rem;
    margin: 3rem 0;
    font-style: italic;
    font-size: 20px;
    line-height: 1.6;
    color: var(--color-ink-secondary);
    position: relative;
  }

  :global(.dark) .prose blockquote {
    border-left-color: var(--color-gold-treasure);
    color: rgba(250, 251, 252, 0.8);
  }

  .prose blockquote::before {
    content: '"';
    position: absolute;
    left: -0.5rem;
    top: -0.5rem;
    font-size: 4rem;
    color: var(--color-copper-orange);
    opacity: 0.2;
    font-family: Georgia, serif;
  }

  /* Horizontal rules */
  .prose hr {
    border: 0;
    height: 2px;
    background: linear-gradient(to right, transparent, var(--color-copper-orange), transparent);
    margin: 4rem 0;
    opacity: 0.3;
  }

  /* Code blocks - Professional styling */
  .prose pre {
    background-color: #1a1a1a;
    color: #f5f5f5;
    padding: 2rem;
    border-radius: 12px;
    overflow-x: auto;
    margin: 3rem 0;
    font-size: 15px;
    line-height: 1.6;
    box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
  }

  .prose code {
    background-color: var(--color-parchment-dark);
    color: var(--color-ink-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
  }

  :global(.dark) .prose code {
    background-color: var(--color-ink-secondary);
    color: var(--color-cyan-primary);
  }

  .prose pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }

  /* Content boxes - Enhanced spacing */
  .prose div[class*="bg-"],
  .prose .bg-parchment-dark,
  .prose .treasure-border {
    margin: 3.5rem 0 !important;
    font-size: 17px;
    line-height: 1.6;
  }

  .prose div[class*="bg-"] p {
    margin-bottom: 1.25rem;
  }

  .prose div[class*="bg-"] p:last-child {
    margin-bottom: 0;
  }

  /* Tables - Clean and readable */
  .prose table {
    width: 100%;
    margin: 3rem 0;
    border-collapse: collapse;
  }

  .prose th {
    background-color: var(--color-copper-orange);
    color: var(--color-parchment-light);
    padding: 1rem;
    text-align: left;
    font-weight: 700;
  }

  .prose td {
    padding: 1rem;
    border-bottom: 1px solid var(--color-parchment-dark);
  }

  :global(.dark) .prose td {
    border-bottom-color: var(--color-ink-faded);
  }

  .prose tr:hover {
    background-color: var(--color-parchment-mid);
  }

  :global(.dark) .prose tr:hover {
    background-color: var(--color-ink-secondary);
  }

  /* Smooth page transitions */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  article {
    animation: fadeIn 0.6s ease-out;
  }

  /* Responsive typography adjustments */
  @media (max-width: 768px) {
    .prose {
      font-size: 17px;
    }

    .prose h2 {
      font-size: 28px;
      margin-top: 3rem;
    }

    .prose h3 {
      font-size: 22px;
    }

    .prose h4 {
      font-size: 19px;
    }

    .prose blockquote {
      font-size: 18px;
      padding-left: 1.5rem;
    }
  }
</style>
